<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#05070C" />
  <title>张莹莹 · 新年快乐</title>

  <!-- 在线字体（可删，离线时会走系统字体兜底） -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Noto+Sans+SC:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#05070C;
      --bg2:#0B0F24;
      --bg3:#1A1238;

      --txt:#F3F4F8;
      --muted:rgba(243,244,248,.72);

      --gold:#D8B56A;
      --blue:#6CA8FF;

      --card: rgba(10,14,30,.56);
      --stroke: rgba(216,181,106,.16);

      --shadow: 0 22px 78px rgba(0,0,0,.55);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font-family:"Noto Serif SC","Songti SC","STSong",serif;
      background:
        radial-gradient(900px 520px at 18% 12%, rgba(216,181,106,.10), transparent 62%),
        radial-gradient(900px 520px at 82% 22%, rgba(108,168,255,.10), transparent 62%),
        linear-gradient(160deg, var(--bg0), var(--bg2) 52%, var(--bg3));
      overflow-x:hidden;
      -webkit-tap-highlight-color: transparent;
    }

    /* 轻颗粒：高级感 */
    body:before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,.020) 0 1px, transparent 1px 3px),
        repeating-linear-gradient(90deg, rgba(255,255,255,.012) 0 1px, transparent 1px 4px);
      opacity:.35; mix-blend-mode: overlay;
    }

    /* 极光层 */
    .aurora{
      position:fixed; inset:-22%;
      background:
        radial-gradient(closest-side at 25% 35%, rgba(108,168,255,.14), transparent 70%),
        radial-gradient(closest-side at 62% 40%, rgba(216,181,106,.12), transparent 68%),
        radial-gradient(closest-side at 42% 72%, rgba(176,120,255,.10), transparent 72%);
      filter: blur(46px);
      opacity:.55;
      animation: drift 18s ease-in-out infinite alternate;
      pointer-events:none;
      z-index:0;
    }
    @keyframes drift{
      0%   {transform: translate3d(-2%, -1%, 0) scale(1.02) rotate(0deg)}
      100% {transform: translate3d(2%, 2%, 0) scale(1.06) rotate(2deg)}
    }

    /* Canvas 层级 */
    canvas#stars{position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:1;}
    canvas#form {position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:2;}
    canvas#fx   {position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:3;}
    canvas#dust {position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:4;}

    .wrap{
      position:relative; z-index:5;
      max-width:980px; margin:0 auto;
      padding:18px 18px 88px;
    }

    .topbar{
      position:sticky; top:0; z-index:30;
      padding:10px 0 14px;
      backdrop-filter: blur(10px);
    }
    .topbar .row{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(5,7,12,.58);
      border:1px solid rgba(216,181,106,.18);
      box-shadow: 0 10px 32px rgba(0,0,0,.35);
      gap:10px;
    }
    .badge{
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-size:12px; color:rgba(243,244,248,.72);
      letter-spacing:.25px;
      white-space:nowrap;
    }
    .hint{
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-size:12px; color:rgba(243,244,248,.78);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .dot{
      width:6px; height:6px; border-radius:999px;
      background: var(--gold);
      box-shadow: 0 0 18px rgba(216,181,106,.9);
    }

    /* Hero */
    .hero{
      min-height:72vh;
      display:flex; flex-direction:column; justify-content:center;
      gap:16px;
      padding:14px 0 18px;
    }
    .title{
      margin:0;
      font-size:56px; line-height:1.05;
      letter-spacing:1px;
      font-weight:600;
      text-shadow: 0 14px 60px rgba(0,0,0,.55);
    }
    .subtitle{
      margin:0;
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-weight:300;
      color:rgba(243,244,248,.82);
      font-size:16px;
      letter-spacing:.6px;
    }
    .lead{
      margin:0; max-width:48ch;
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-size:15px; line-height:2.0;
      color:rgba(243,244,248,.80);
    }
    .btns{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    button{
      border:0; cursor:pointer;
      border-radius:999px;
      padding:12px 16px;
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-weight:700;
      font-size:14px;
      transition: transform .14s ease, filter .2s ease;
    }
    button:active{transform:scale(.98)}
    .primary{
      background: linear-gradient(135deg, rgba(216,181,106,.96), rgba(216,181,106,.55));
      color:#111018;
      box-shadow: 0 14px 40px rgba(216,181,106,.18);
    }
    .ghost{
      background: rgba(255,255,255,.06);
      color: rgba(243,244,248,.92);
      border: 1px solid rgba(216,181,106,.22);
    }
    .mini{
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-size:12px; color:rgba(243,244,248,.62);
      line-height:1.7;
    }

    .section{margin-top:18px}
    .card{
      border-radius: var(--radius);
      background: var(--card);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      padding:18px 18px 16px;
    }
    .h2{margin:0 0 10px; font-size:18px; letter-spacing:.6px;}
    .p{
      margin:0;
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-size:14px; line-height:2.0;
      color:rgba(243,244,248,.80);
    }
    .poem{display:grid; gap:10px; margin-top:10px}
    .line{
      padding:12px 14px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.06);
      font-size:16px; line-height:1.75;
    }
    .signature{
      margin-top:12px;
      font-size:16px;
      color:rgba(243,244,248,.82);
    }

    /* Reveal */
    .reveal{opacity:0; transform: translateY(14px); transition: opacity .9s ease, transform .9s ease;}
    .reveal.in{opacity:1; transform: translateY(0)}
    @media (prefers-reduced-motion: reduce){
      .aurora{animation:none}
      .reveal{opacity:1; transform:none; transition:none}
      button{transition:none}
    }

    /* ===== 创意开场：蜡封信封 ===== */
    .gate{
      position:fixed; inset:0; z-index:60;
      display:grid; place-items:center;
      background:
        radial-gradient(900px 600px at 50% 40%, rgba(108,168,255,.10), transparent 60%),
        rgba(5,7,12,.92);
      backdrop-filter: blur(12px);
      transition: opacity .7s ease, transform .7s ease;
      padding:18px;
    }
    .gate.gone{opacity:0; pointer-events:none; transform: translateY(-8px)}
    .gateInner{
      width:min(520px, 94vw);
      text-align:center;
      display:flex; flex-direction:column; align-items:center;
      gap:14px;
    }

    .env{
      width:min(380px, 90vw);
      aspect-ratio: 16 / 10;
      position:relative;
      perspective: 900px;
    }
    .envBase{
      position:absolute; inset:0;
      border-radius: 24px;
      border:1px solid rgba(216,181,106,.22);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      box-shadow: 0 26px 90px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .paper{
      position:absolute;
      left:10%; right:10%;
      bottom:16%;
      height:70%;
      border-radius:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
      color:#121316;
      box-shadow: 0 14px 40px rgba(0,0,0,.28);
      transform: translateY(38%);
      transition: transform 900ms cubic-bezier(.2,.8,.2,1);
      overflow:hidden;
    }
    .paper:before{
      content:""; position:absolute; inset:0;
      background:
        radial-gradient(500px 140px at 20% 0%, rgba(216,181,106,.18), transparent 60%),
        radial-gradient(400px 120px at 90% 100%, rgba(108,168,255,.12), transparent 65%);
      opacity:.9;
      pointer-events:none;
    }
    .paperIn{position:relative; padding:14px; text-align:left;}
    .paperTo{
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-size:12px; color:rgba(10,10,10,.65);
      letter-spacing:.2px;
    }
    .paperBig{
      margin-top:8px;
      font-family:"Noto Serif SC",serif;
      font-size:18px; font-weight:600;
      color:#0c0c10;
    }
    .paperLine{
      margin-top:10px;
      height:10px;
      background: linear-gradient(90deg, rgba(0,0,0,.08), transparent);
      border-radius:999px;
      opacity:.55;
    }

    .front{
      position:absolute; inset:0;
      border-radius:24px;
      overflow:hidden;
      pointer-events:none;
    }
    .tri{position:absolute; inset:0; background: rgba(255,255,255,.08);}
    .tri.bottom{
      inset:auto -2px -2px -2px;
      height:62%;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      clip-path: polygon(0 100%, 50% 18%, 100% 100%);
    }
    .tri.left{
      inset:-2px auto -2px -2px;
      width:54%;
      background: rgba(255,255,255,.05);
      clip-path: polygon(0 0, 100% 50%, 0 100%);
    }
    .tri.right{
      inset:-2px -2px -2px auto;
      width:54%;
      background: rgba(255,255,255,.05);
      clip-path: polygon(100% 0, 0 50%, 100% 100%);
    }

    .flap{
      position:absolute; left:-2px; right:-2px; top:-2px;
      height:58%;
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      clip-path: polygon(0 0, 50% 100%, 100% 0);
      transform-origin: 50% 0%;
      transform: rotateX(0deg);
      transition: transform 950ms cubic-bezier(.2,.8,.2,1);
      backface-visibility:hidden;
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
    }

    .sealBtn{
      position:absolute;
      left:50%; top:56%;
      transform: translate(-50%, -50%);
      width:68px; height:68px;
      border-radius:999px;
      border:1px solid rgba(216,181,106,.35);
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.22), transparent 55%),
        radial-gradient(circle at 65% 70%, rgba(0,0,0,.18), transparent 55%),
        linear-gradient(135deg, rgba(216,181,106,.95), rgba(216,181,106,.55));
      box-shadow: 0 18px 55px rgba(216,181,106,.18), 0 22px 70px rgba(0,0,0,.55);
      color:#141018;
      font-family:"Noto Serif SC",serif;
      font-weight:700;
      font-size:22px;
      cursor:pointer;
      transition: transform .5s ease, opacity .5s ease;
    }
    .sealHint{
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-size:12px;
      color:rgba(243,244,248,.75);
      margin-top:6px;
    }

    .gateMeta{
      width:100%;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-family:"Noto Sans SC",system-ui,sans-serif;
      color:rgba(243,244,248,.70);
      font-size:12px;
    }
    .chip{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(216,181,106,.22);
      background: rgba(255,255,255,.03);
    }
    .gateTitle{
      margin:0;
      font-family:"Noto Serif SC",serif;
      font-size:22px; line-height:1.7;
      letter-spacing:.4px;
    }
    .gateSub{
      margin:0;
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-size:13px; line-height:1.9;
      color:rgba(243,244,248,.78);
    }
    .gateBtns{display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:2px;}

    .gate.opening .flap{transform: rotateX(-180deg) translateY(-2px);}
    .gate.opening .paper{transform: translateY(-12%);}
    .gate.opening .sealBtn{opacity:0; transform: translate(-50%, -50%) scale(0.72);}

    /* ===== 刮刮卡 ===== */
    .scratchBox{
      margin-top:12px;
      position:relative;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(255,255,255,.03);
      min-height: 160px;
    }
    .secret{padding:16px 14px 44px; text-align:left; position:relative;}
    .secretName{
      font-family:"Noto Serif SC",serif;
      font-size:18px; font-weight:600; letter-spacing:.4px;
      margin-bottom:6px;
    }
    .secretMsg{
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-size:14px; line-height:1.95;
      color:rgba(243,244,248,.84);
    }
    .secretSmall{
      position:absolute; right:14px; bottom:12px;
      margin-top:0;
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-size:12px;
      color:rgba(243,244,248,.62);
      text-align:right;
    }
    #scratch{
      position:absolute; inset:0;
      width:100%; height:100%;
      border-radius:18px;
      touch-action: none;
      transition: opacity .65s ease, transform .65s ease;
    }
    .scratchBox.done #scratch{
      opacity:0;
      transform: translateY(-2px);
      pointer-events:none;
    }

    /* Fortune modal */
    .modal{
      position:fixed; inset:0; z-index:70;
      display:none; place-items:center;
      background: rgba(0,0,0,.58);
      padding:18px;
    }
    .modal.show{display:grid}
    .flipWrap{width:min(440px, 94vw); perspective: 1200px;}
    .flip{
      position:relative; width:100%; min-height:280px;
      transform-style: preserve-3d;
      transition: transform .75s cubic-bezier(.2,.7,.2,1);
    }
    .flip.isFlipped{transform: rotateY(180deg)}
    .face{
      position:absolute; inset:0;
      border-radius: 24px;
      border:1px solid rgba(216,181,106,.26);
      background: linear-gradient(180deg, rgba(10,14,30,.88), rgba(5,7,12,.86));
      box-shadow: 0 26px 90px rgba(0,0,0,.65);
      backface-visibility: hidden;
      padding:18px;
      overflow:hidden;
    }
    .face:before{
      content:""; position:absolute; inset:-1px;
      background:
        radial-gradient(760px 260px at 15% 0%, rgba(216,181,106,.16), transparent 65%),
        radial-gradient(520px 260px at 85% 100%, rgba(108,168,255,.14), transparent 70%);
      opacity:.95;
      pointer-events:none;
    }
    .face > *{position:relative}
    .back{transform: rotateY(180deg)}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-size:12px; color:rgba(243,244,248,.8);
      border:1px solid rgba(216,181,106,.22);
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.03);
    }
    .big{
      margin:14px 0 6px;
      font-size:22px; line-height:1.55; font-weight:700;
      letter-spacing:.4px;
      font-family:"Noto Serif SC",serif;
    }
    .closeRow{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:14px;}
    .xbtn{background:transparent; color:rgba(243,244,248,.75); border:1px solid rgba(255,255,255,.14)}
    .foot{
      margin-top:24px;
      text-align:center;
      font-family:"Noto Sans SC",system-ui,sans-serif;
      font-size:12px; color:rgba(243,244,248,.52);
    }
  </style>
</head>

<body>
  <div class="aurora"></div>
  <canvas id="stars"></canvas>
  <canvas id="form"></canvas>
  <canvas id="fx"></canvas>
  <canvas id="dust"></canvas>

  <!-- 蜡封信封开场 -->
  <div class="gate" id="gate">
    <div class="gateInner">
      <div class="gateMeta">
        <div id="gateTime">2026-01-01 00:00</div>
        <div class="chip" id="gateChip">给 张莹莹</div>
      </div>

      <div class="env" aria-hidden="true">
        <div class="envBase"></div>

        <div class="paper" id="paper">
          <div class="paperIn">
            <div class="paperTo" id="paperTo">To 张莹莹</div>
            <div class="paperBig" id="paperBig">新年快乐</div>
            <div class="paperLine"></div>
            <div class="paperLine" style="width:78%"></div>
            <div class="paperLine" style="width:62%"></div>
          </div>
        </div>

        <div class="front">
          <div class="tri left"></div>
          <div class="tri right"></div>
          <div class="tri bottom"></div>
        </div>

        <div class="flap"></div>

        <button class="sealBtn" id="sealBtn" aria-label="揭开蜡封">封</button>
      </div>

      <div class="sealHint">轻触蜡封 · 解锁这封新年信</div>

      <h2 class="gateTitle" id="gateTitle">把新年的第一份认真，交给你。</h2>
      <p class="gateSub">（星光会成字；最后还有刮刮卡。点击空白处也会有小烟花。）</p>

      <div class="gateBtns">
        <button class="primary" id="unlock">揭开蜡封</button>
        <button class="ghost" id="preview">先看星光成字</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="row">
        <div class="badge" id="nowText">2026-01-01 00:00</div>
        <div class="hint"><span class="dot"></span><span>空白处轻点：小烟花</span></div>
      </div>
    </div>

    <section class="hero">
      <h1 class="title reveal" id="toNameBig">张莹莹</h1>
      <p class="subtitle reveal">新年快乐 · <span id="yearText">2026</span></p>
      <p class="lead reveal" id="leadText">我想把新年的第一份认真，做成一个页面，发给你。</p>

      <div class="btns reveal">
        <button class="primary" id="btnForm">星光为你成字</button>
        <button class="ghost" id="btnFortune">抽一张新年签</button>
        <button class="ghost" id="btnBigFire">放一场更认真一点的烟花</button>
      </div>

    </section>

    <section class="section reveal">
      <div class="card">
        <div class="h2">给你的三行祝福</div>
        <div class="poem" id="poemBox"></div>
      </div>
    </section>

    <section class="section reveal">
      <div class="card">
        <div class="h2">想对你说</div>
        <p class="p" id="letterText"></p>
        <div class="signature" id="fromName">——姜南</div>
      </div>
    </section>

    <section class="section reveal">
      <div class="card">
        <div class="h2">最后的小彩蛋</div>
        <p class="p">用手指轻轻刮开（刮开超过一半会自动完成）。</p>

        <div class="scratchBox" id="scratchBox">
          <div class="secret">
            <div class="secretName" id="secretName">张莹莹</div>
            <div class="secretMsg" id="secretMsg">（刮开后会出现）</div>
            <div class="secretSmall" id="secretFrom">——姜南</div>
          </div>
          <canvas id="scratch"></canvas>
        </div>

        <div class="mini" style="margin-top:10px">（刮开后会换成另一段字。）</div>
      </div>
    </section>

    <div class="foot" id="footTime"></div>
  </div>

  <!-- 抽签 Modal -->
  <div class="modal" id="modal">
    <div class="flipWrap">
      <div class="flip" id="flip">
        <div class="face front">
          <div class="tag">新年签 · 点击翻开</div>
          <div class="big">这一张，属于你</div>
          <p class="p">点一下卡片翻面，翻开时会撒一点金粉。</p>
          <div class="closeRow">
            <button class="ghost" id="flipBtn">翻开</button>
            <button class="xbtn" id="closeBtn">关闭</button>
          </div>
        </div>
        <div class="face back">
          <div class="tag" id="fortuneTag">上上签 · 2026</div>
          <div class="big" id="fortuneBig">你会遇到很多温柔的好事</div>
          <p class="p" id="fortuneSmall">而你本身，就是其中之一。</p>
          <div class="closeRow">
            <button class="primary" id="againBtn">再抽一张</button>
            <button class="xbtn" id="closeBtn2">收起</button>
          </div>
        </div>
      </div>
      <div class="foot">（喜欢这张签，也可以截图保存。）</div>
    </div>
  </div>

<script>
(() => {
  /* =========================
     只改这里就够（定制区）
  ========================== */
  const CONFIG = {
    toName: "张莹莹",
    fromName: "——姜南",

    lead: "我想把新年的第一份认真，做成一个页面，发给你。",

    poem: [
      "愿你今年的每一步，都走得踏实。",
      "愿你被世界温柔以待，也永远温柔自己。",
      "愿你抬头时有光，低头时有路。"
    ],

    letterHTML: `
      缘分真的很神奇，让本不会有联系的我们再度相逢。<br/>
      并且慢慢成为对方重要的人，遇见你真的很幸运。<br/>
      张莹莹，在新的一年，如果你愿意，我想更认真地走近你。<br/>
      不急、不打扰，但会一直真诚。
    `,

    // 刮刮卡两种状态：
    secretBefore: "如果可以，2026 我想更认真地走近你。",
    secretAfter:  "张莹莹，新年快乐。愿你今年所有愿望都慢慢实现。",

    fortunes: [
      {tag:"上上签", big:"你会遇到很多温柔的好事", small:"而你本身，就是其中之一。"},
      {tag:"上上签", big:"今年你的努力会被看见", small:"也会被珍惜。"},
      {tag:"中上签", big:"你会越来越笃定自己", small:"然后闪闪发光。"},
      {tag:"上上签", big:"你会收获更踏实的快乐", small:"来自日常，也来自自己。"},
      {tag:"中上签", big:"愿你心里有盼头", small:"也有人在悄悄祝福你。"},
      {tag:"上上签", big:"好运会靠近你", small:"我也想。"},
      {tag:"中上签", big:"你会在某个瞬间发现", small:"原来幸福已经在路上。"},
      {tag:"上上签", big:"愿你被温柔包围", small:"也拥有温柔的勇气。"}
    ]
  };

  /* =========================
     DOM 绑定
  ========================== */
  const $ = (s) => document.querySelector(s);

  $("#toNameBig").textContent = CONFIG.toName;
  $("#leadText").textContent = CONFIG.lead;
  $("#fromName").textContent = CONFIG.fromName;

  $("#gateChip").textContent = `给 ${CONFIG.toName}`;
  $("#paperTo").textContent = `To ${CONFIG.toName}`;
  $("#poemBox").innerHTML = CONFIG.poem.map(t => `<div class="line">${t}</div>`).join("");
  $("#letterText").innerHTML = CONFIG.letterHTML;

  $("#secretName").textContent = CONFIG.toName;
  $("#secretMsg").textContent = CONFIG.secretBefore;
  $("#secretFrom").textContent = CONFIG.fromName;

  /* =========================
     时间显示
  ========================== */
  const nowText = $("#nowText");
  const footTime = $("#footTime");
  const gateTime = $("#gateTime");
  const yearText = $("#yearText");

  const pad = n => String(n).padStart(2,'0');
  function updateTime(){
    const d = new Date();
    const t = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}  ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    nowText.textContent = t;
    gateTime.textContent = t;
    yearText.textContent = d.getFullYear();
    footTime.textContent = `在 ${d.getFullYear()} 年的此刻，把这份祝福发给你。`;
  }
  updateTime(); setInterval(updateTime, 30000);

  /* =========================
     Reveal
  ========================== */
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add("in"); });
  }, {threshold:0.12});
  document.querySelectorAll(".reveal").forEach(el => io.observe(el));

  /* =========================
     Canvas 初始化
  ========================== */
  const reduceMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

  const cStars = $("#stars");
  const cForm  = $("#form");
  const cFx    = $("#fx");
  const cDust  = $("#dust");

  const sctx = cStars.getContext("2d", {alpha:true});
  const fctx = cForm.getContext("2d",  {alpha:true});
  const xctx = cFx.getContext("2d",    {alpha:true});
  const dctx = cDust.getContext("2d",  {alpha:true});

  let W=0,H=0,dpr=1;
  const rand = (a,b)=> a + Math.random()*(b-a);

  function fitCanvas(canvas, ctx){
    canvas.width  = Math.floor(W * dpr);
    canvas.height = Math.floor(H * dpr);
    canvas.style.width = W + "px";
    canvas.style.height= H + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  /* =========================
     星星背景
  ========================== */
  let stars = [];
  function initStars(){
    const base = Math.floor(Math.max(80, Math.min(160, W * 0.28)));
    const count = reduceMotion ? Math.floor(base*0.55) : base;
    stars = Array.from({length:count}, () => ({
      x: Math.random()*W,
      y: Math.random()*H,
      r: Math.random()*1.2 + 0.3,
      a: Math.random()*0.40 + 0.06,
      s: Math.random()*0.18 + 0.03,
      tw: Math.random()*0.015 + 0.005
    }));
  }

  /* =========================
     星光成字 + 爱心（核心）
  ========================== */
  const off = document.createElement("canvas");
  const offCtx = off.getContext("2d", {willReadFrequently:true});

  /** @type {{x:number,y:number}[]} */
  let targets = [];
  /** @type {{x:number,y:number,vx:number,vy:number,tx:number,ty:number,r:number,hue:number,a:number,tw:number,}[]} */
  let dots = [];
  let formed = false;

  function capArray(arr, cap){
    if(arr.length <= cap) return arr;
    const step = Math.ceil(arr.length / cap);
    return arr.filter((_,i)=> i % step === 0);
  }

  function sampleTargets(gap, threshold, xOffset, yOffset, scale){
    const img = offCtx.getImageData(0,0,off.width,off.height).data;
    const out = [];
    for(let y=0; y<off.height; y+=gap){
      for(let x=0; x<off.width; x+=gap){
        const a = img[(y*off.width + x)*4 + 3];
        if(a > threshold){
          out.push({ x: x/scale + xOffset, y: y/scale + yOffset });
        }
      }
    }
    return out;
  }

  

  // ✅ 修复 + 增强：单一 buildTargets（你文件里之前有重复定义，导致字形/逻辑异常） 
  function buildTargets(){
    const areaW = Math.min(980, Math.max(360, W - 24));
    const areaH = Math.min(360, Math.max(260, Math.floor(H * 0.38)));

    // 更高分辨率离屏：中文笔画更完整
    const scale = Math.max(2, Math.round(dpr * 1.7)); // 2~3
    off.width  = Math.floor(areaW * scale);
    off.height = Math.floor(areaH * scale);
    offCtx.setTransform(scale,0,0,scale,0,0);

    const xOffset = (W - areaW)/2;
    const yOffset = Math.max(78, H * 0.115);

    // ---- 1) 文本字号（自动缩放避免裁剪）
    offCtx.clearRect(0,0,areaW,areaH);
    offCtx.fillStyle = "#fff";
    offCtx.textAlign = "center";
    offCtx.textBaseline = "middle";

    let fs1 = Math.min(104, Math.max(62, areaW * 0.23));
    const maxW = areaW * 0.92;
    while(true){
      offCtx.font = `700 ${fs1}px "Noto Serif SC","Songti SC","STSong",serif`;
      if(offCtx.measureText(CONFIG.toName).width <= maxW || fs1 <= 44) break;
      fs1 -= 2;
    }

    const nameX = areaW/2;
    const nameY = areaH*0.46;

    // ---- 2) 画文字（描边 + 填充，修复“张”细横丢点）
    offCtx.clearRect(0,0,areaW,areaH);
    offCtx.fillStyle = "#fff";
    offCtx.textAlign = "center";
    offCtx.textBaseline = "middle";

    offCtx.save();
    offCtx.lineJoin = "round";
    offCtx.lineCap = "round";
    offCtx.miterLimit = 2;

    offCtx.font = `700 ${fs1}px "Noto Serif SC","Songti SC","STSong",serif`;
    offCtx.lineWidth = Math.max(2.6, fs1 * 0.065);
    offCtx.strokeStyle = "#fff";
    offCtx.strokeText(CONFIG.toName, nameX, nameY);
    offCtx.fillText(CONFIG.toName, nameX, nameY);
    offCtx.restore();

    // 第二行：新年快乐（按你的要求：放在名字下方）
    const fs2 = Math.min(34, Math.max(20, areaW * 0.07));
    offCtx.font = `600 ${fs2}px "Noto Serif SC","Songti SC","STSong",serif`;
    offCtx.fillText("新年快乐", areaW/2, areaH*0.74);

    // ---- 3) 采样点位
    const gapText = Math.max(4, Math.floor(off.width / 320)); // 越小越密
    let textTargets = sampleTargets(gapText, 16, xOffset, yOffset, scale);
    textTargets = capArray(textTargets, reduceMotion ? 1500 : 3000);

    targets = textTargets;

    // ---- 4) 生成粒子
    const hueForText = () => (Math.random() < 0.62) ? rand(38,56) : rand(200,222);

    dots = targets.map(t=>({
      x: rand(0,W), y: rand(0,H),
      vx:0, vy:0,
      tx:t.x, ty:t.y,
      r: rand(0.95, 1.85),
      hue: hueForText(),
      a: rand(0.55, 0.95),
      tw: rand(0, Math.PI*2)
    }));

    formed = true;
  }

  function scatterDots(){
    if(!formed) return;
    dots.forEach(p=>{
      p.tx = rand(0,W);
      p.ty = rand(H*0.08, H*0.62);
    });
  }

  function formDots(){
    if(!formed) return;
    for(let i=0;i<dots.length;i++){
      const p = dots[i];
      const t = targets[i];
      p.tx = t.x; p.ty = t.y;
    }
  }

  // ✅ 单击切换：明确状态机（解决需要点两下）
  const btnForm = $("#btnForm");
  let isFormState = false; // false=散开, true=成字
  function setFormState(next){
    isFormState = next;
    if(isFormState){
      formDots();
      btnForm.textContent = "让星光散开";
      sprinkle(0.45);
    }else{
      scatterDots();
      btnForm.textContent = "星光为你成字";
    }
  }

  // 字体加载完成再重建一次：解决中文形状不对
  function rebuildTargetsPreserveState(){
    const keep = isFormState;
    buildTargets();
    setFormState(keep);
  }

  /* =========================
     烟花
  ========================== */
  const sparks = [];
  function spawnFirework(x,y, power=1){
    const count = Math.floor(rand(85, 115) * power);
    const palette = [
      {h:42,  s:72, l:66},  // gold
      {h:210, s:72, l:68},  // blue
      {h:320, s:64, l:72}   // pink
    ];
    for(let i=0;i<count;i++){
      const ang = rand(0, Math.PI*2);
      const spd = rand(2.0, 6.4) * power;
      const c = palette[Math.floor(rand(0,palette.length))];
      sparks.push({
        x,y,
        vx: Math.cos(ang)*spd,
        vy: Math.sin(ang)*spd,
        g: rand(0.04, 0.09),
        drag: rand(0.982, 0.990),
        life: rand(58, 92),
        a: 1,
        r: rand(1.1, 2.2),
        h: c.h, s: c.s, l: c.l
      });
    }
  }

  /* =========================
     金粉 confetti
  ========================== */
  const dustBits = [];
  function sprinkle(strength=1){
    const n = Math.floor(150 * strength);
    const cx = W*0.5, cy = H*0.32;
    for(let i=0;i<n;i++){
      dustBits.push({
        x: cx + rand(-70,70),
        y: cy + rand(-18,18),
        vx: rand(-2.8,2.8)*strength,
        vy: rand(-1.8,3.8)*strength,
        rot: rand(0,Math.PI),
        vr: rand(-0.18,0.18),
        w: rand(6,10),
        h: rand(3,7),
        a: 1,
        life: rand(90,130),
        c: (Math.random()<0.74) ? "rgba(216,181,106,.95)" : "rgba(243,244,248,.85)"
      });
    }
  }

  /* =========================
     Resize
  ========================== */
  function drawScratchCover(){} // 先声明，后面会实现

  function resize(){
    dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    W = innerWidth; H = innerHeight;

    fitCanvas(cStars, sctx);
    fitCanvas(cForm,  fctx);
    fitCanvas(cFx,    xctx);
    fitCanvas(cDust,  dctx);

    initStars();
    rebuildTargetsPreserveState();
    drawScratchCover();
  }
  addEventListener("resize", resize, {passive:true});

  // 首次初始化
  (function initOnce(){
    dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    W = innerWidth; H = innerHeight;
    fitCanvas(cStars, sctx);
    fitCanvas(cForm,  fctx);
    fitCanvas(cFx,    xctx);
    fitCanvas(cDust,  dctx);
    initStars();
    buildTargets();
    setFormState(false); // 初始散开
  })();

  // 字体 ready 后再重建一次（关键修复）
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(() => rebuildTargetsPreserveState());
  }

  /* =========================
     主循环
  ========================== */
  const pointer = {x:0, y:0, on:false};

  function drawStars(t){
    sctx.clearRect(0,0,W,H);
    for(const p of stars){
      p.y += reduceMotion ? p.s*0.45 : p.s;
      if(p.y > H + 10){ p.y = -10; p.x = Math.random()*W; }
      const tw = (Math.sin((t||0) * p.tw) * 0.25 + 0.75);
      sctx.globalAlpha = p.a * tw;
      sctx.fillStyle = "rgba(243,244,248,1)";
      sctx.beginPath();
      sctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      sctx.fill();
    }
    sctx.globalAlpha = 1;
  }

  function drawForm(t){
    fctx.clearRect(0,0,W,H);
    fctx.globalCompositeOperation = "lighter";

    for(const p of dots){
      // spring to target
      const ax = (p.tx - p.x) * 0.018;
      const ay = (p.ty - p.y) * 0.018;
      p.vx = (p.vx + ax) * 0.88;
      p.vy = (p.vy + ay) * 0.88;

      // pointer repel（更自然）
      if(pointer.on){
        const dx = p.x - pointer.x, dy = p.y - pointer.y;
        const d2 = dx*dx + dy*dy;
        if(d2 < 120*120){
          const d = Math.sqrt(d2) || 1;
          const push = (120 - d) / 120 * 0.9;
          p.vx += (dx/d) * push * 0.25;
          p.vy += (dy/d) * push * 0.25;
        }
      }

      p.x += p.vx;
      p.y += p.vy;

      // 微闪烁：更像星星
      const tw = 0.82 + 0.18*Math.sin((t||0)*0.002 + p.tw);
      const alpha = p.a * tw;

      fctx.globalAlpha = alpha;
      fctx.fillStyle = `hsla(${p.hue} 75% 70% / ${alpha})`;
      fctx.beginPath();
      fctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      fctx.fill();
    }

    fctx.globalAlpha = 1;
    fctx.globalCompositeOperation = "source-over";
  }

  function drawFireworks(){
    xctx.clearRect(0,0,W,H);
    xctx.globalCompositeOperation = "lighter";
    for(let i=sparks.length-1;i>=0;i--){
      const p = sparks[i];
      p.x += p.vx;
      p.y += p.vy;
      p.vx *= p.drag;
      p.vy = p.vy*p.drag + p.g*8;
      p.life -= 1;
      p.a *= 0.976;

      const alpha = Math.max(0, p.a);
      if(alpha > 0.02){
        xctx.globalAlpha = alpha;
        xctx.fillStyle = `hsla(${p.h} ${p.s}% ${p.l}% / ${alpha})`;
        xctx.beginPath();
        xctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        xctx.fill();
      }
      if(p.life<=0 || p.a<0.02 || p.x<-60 || p.x>W+60 || p.y<-60 || p.y>H+140){
        sparks.splice(i,1);
      }
    }
    xctx.globalAlpha = 1;
    xctx.globalCompositeOperation = "source-over";
  }

  function drawDust(){
    dctx.clearRect(0,0,W,H);
    for(let i=dustBits.length-1;i>=0;i--){
      const b = dustBits[i];
      b.x += b.vx;
      b.y += b.vy;
      b.vy += 0.10;
      b.vx *= 0.992;
      b.rot += b.vr;
      b.life -= 1;
      b.a *= 0.988;

      dctx.save();
      dctx.globalAlpha = Math.max(0,b.a);
      dctx.translate(b.x,b.y);
      dctx.rotate(b.rot);
      dctx.fillStyle = b.c;
      dctx.fillRect(-b.w/2, -b.h/2, b.w, b.h);
      dctx.restore();

      if(b.life<=0 || b.y>H+90 || b.a<0.03) dustBits.splice(i,1);
    }
  }

  function loop(t){
    drawStars(t);
    drawForm(t);
    drawFireworks();
    drawDust();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  /* =========================
     交互：按钮
  ========================== */
  btnForm.addEventListener("click", ()=> setFormState(!isFormState));

  $("#btnBigFire").addEventListener("click", ()=>{
    spawnFirework(W*0.50, H*0.30, 1.25);
    spawnFirework(W*0.34, H*0.42, 0.92);
    spawnFirework(W*0.66, H*0.42, 0.92);
  });

  // 空白处点一下：小烟花
  addEventListener("pointerdown", (e)=>{
    const gate = $("#gate");
    if(!gate.classList.contains("gone")) return;
    if($("#modal").classList.contains("show")) return;
    if(e.target.closest("button")) return;
    if(e.target.id === "scratch") return;
    spawnFirework(e.clientX, e.clientY, 0.9);
  }, {passive:true});

  // pointer repel
  addEventListener("pointermove", (e)=>{
    const gate = $("#gate");
    if(!gate.classList.contains("gone")) return;
    pointer.on = true;
    pointer.x = e.clientX;
    pointer.y = e.clientY;
  }, {passive:true});
  addEventListener("pointerup", ()=>{ pointer.on = false; }, {passive:true});
  addEventListener("pointercancel", ()=>{ pointer.on = false; }, {passive:true});

  /* =========================
     开场蜡封
  ========================== */
  const gateEl = $("#gate");
  function openGate(){
    if(gateEl.classList.contains("opening")) return;
    gateEl.classList.add("opening");

    setFormState(true);
    spawnFirework(W*0.50, H*0.34, 1.05);

    setTimeout(()=>{
      gateEl.classList.add("gone");
      sprinkle(0.75);
    }, 980);
  }
  $("#sealBtn").addEventListener("click", openGate);
  $("#unlock").addEventListener("click", openGate);
  $("#preview").addEventListener("click", ()=> setFormState(true));

  /* =========================
     抽签 Modal
  ========================== */
  const modal = $("#modal");
  const flip = $("#flip");
  const fortuneTag = $("#fortuneTag");
  const fortuneBig = $("#fortuneBig");
  const fortuneSmall = $("#fortuneSmall");

  function pickFortune(){
    const f = CONFIG.fortunes[Math.floor(Math.random()*CONFIG.fortunes.length)];
    fortuneTag.textContent = `${f.tag} · ${new Date().getFullYear()}`;
    fortuneBig.textContent = f.big;
    fortuneSmall.textContent = f.small;
  }
  function openModal(){
    pickFortune();
    modal.classList.add("show");
    flip.classList.remove("isFlipped");
    spawnFirework(W*0.50, H*0.30, 0.75);
  }
  function closeModal(){
    modal.classList.remove("show");
    flip.classList.remove("isFlipped");
  }

  $("#btnFortune").addEventListener("click", openModal);
  $("#flipBtn").addEventListener("click", ()=>{
    flip.classList.add("isFlipped");
    sprinkle(0.9);
  });
  $("#againBtn").addEventListener("click", ()=>{
    pickFortune();
    sprinkle(0.85);
  });
  $("#closeBtn").addEventListener("click", closeModal);
  $("#closeBtn2").addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });
  flip.addEventListener("click", ()=>{
    flip.classList.toggle("isFlipped");
    if(flip.classList.contains("isFlipped")) sprinkle(0.8);
  });

  /* =========================
     刮刮卡（两种状态：刮完换字）
  ========================== */
  const scratchBox = $("#scratchBox");
  const scratchCanvas = $("#scratch");
  const scratchCtx = scratchCanvas.getContext("2d", {willReadFrequently:true});
  let scratching = false;

  function sizeScratchCanvas(){
    const rect = scratchBox.getBoundingClientRect();
    const w = Math.max(260, rect.width);
    const h = Math.max(160, rect.height);

    scratchCanvas.width = Math.floor(w * dpr);
    scratchCanvas.height= Math.floor(h * dpr);
    scratchCanvas.style.width = w + "px";
    scratchCanvas.style.height= h + "px";
    scratchCtx.setTransform(dpr,0,0,dpr,0,0);
  }

  drawScratchCover = function(){
    try{ sizeScratchCanvas(); }catch(_){ return; }
    const w = scratchCanvas.width / dpr;
    const h = scratchCanvas.height / dpr;

    scratchCtx.globalCompositeOperation = "source-over";
    scratchCtx.clearRect(0,0,w,h);

    // 盖层：金属箔质感
    const g = scratchCtx.createLinearGradient(0,0,w,h);
    g.addColorStop(0, "rgba(216,181,106,.55)");
    g.addColorStop(0.45, "rgba(243,244,248,.22)");
    g.addColorStop(1, "rgba(108,168,255,.18)");
    scratchCtx.fillStyle = g;
    scratchCtx.fillRect(0,0,w,h);

    // 轻纹理
    scratchCtx.globalAlpha = 0.18;
    for(let i=0;i<60;i++){
      scratchCtx.fillStyle = (i%2===0) ? "rgba(0,0,0,.25)" : "rgba(255,255,255,.25)";
      const x = (i*29)%w;
      const y = (i*17)%h;
      scratchCtx.fillRect(x,y, 1, 1);
    }
    scratchCtx.globalAlpha = 1;

    // 提示文字
    scratchCtx.fillStyle = "rgba(10,10,12,.75)";
    scratchCtx.font = `700 16px "Noto Sans SC", system-ui, sans-serif`;
    scratchCtx.textAlign = "center";
    scratchCtx.textBaseline = "middle";
    scratchCtx.fillText("轻轻刮开", w/2, h/2 - 10);

    scratchCtx.font = `400 12px "Noto Sans SC", system-ui, sans-serif`;
    scratchCtx.fillStyle = "rgba(10,10,12,.62)";
    scratchCtx.fillText("（刮出你的新年彩蛋）", w/2, h/2 + 14);

    scratchBox.classList.remove("done");
    $("#secretMsg").textContent = CONFIG.secretBefore;
  };

  function scratchAt(x,y){
    const w = scratchCanvas.width / dpr;
    const h = scratchCanvas.height / dpr;
    if(x<0||y<0||x>w||y>h) return;

    scratchCtx.save();
    scratchCtx.globalCompositeOperation = "destination-out";

    const r = 22;
    const rg = scratchCtx.createRadialGradient(x,y,0,x,y,r);
    rg.addColorStop(0, "rgba(0,0,0,0.90)");
    rg.addColorStop(1, "rgba(0,0,0,0)");
    scratchCtx.fillStyle = rg;

    scratchCtx.beginPath();
    scratchCtx.arc(x,y,r,0,Math.PI*2);
    scratchCtx.fill();

    scratchCtx.restore();
  }

  function scratchedRatio(){
    const w = scratchCanvas.width;
    const h = scratchCanvas.height;
    const img = scratchCtx.getImageData(0,0,w,h).data;

    const step = Math.max(10, Math.floor(12 * dpr)); // 采样步长
    let total = 0, remain = 0;

    for(let y=0; y<h; y+=step){
      for(let x=0; x<w; x+=step){
        const a = img[(y*w + x)*4 + 3];
        total++;
        if(a > 30) remain++;
      }
    }
    return 1 - (remain / total);
  }

  function finishScratch(){
    if(scratchBox.classList.contains("done")) return;
    scratchBox.classList.add("done");

    // ✅刮完换另一段字（两种状态）
    const msg = $("#secretMsg");
    msg.style.transition = "opacity .25s ease, transform .25s ease";
    msg.style.opacity = "0";
    msg.style.transform = "translateY(4px)";
    setTimeout(() => {
      msg.textContent = CONFIG.secretAfter;
      msg.style.opacity = "1";
      msg.style.transform = "translateY(0)";
    }, 220);

    // 仪式感：金粉+烟花
    sprinkle(1.0);
    spawnFirework(W*0.50, H*0.34, 1.05);
    spawnFirework(W*0.36, H*0.44, 0.85);
    spawnFirework(W*0.64, H*0.44, 0.85);
  }

  scratchCanvas.addEventListener("pointerdown", (e)=>{
    if(!$("#gate").classList.contains("gone")) return;
    scratching = true;
    scratchCanvas.setPointerCapture(e.pointerId);

    const rect = scratchCanvas.getBoundingClientRect();
    scratchAt(e.clientX - rect.left, e.clientY - rect.top);
  });
  scratchCanvas.addEventListener("pointermove", (e)=>{
    if(!scratching) return;
    const rect = scratchCanvas.getBoundingClientRect();
    scratchAt(e.clientX - rect.left, e.clientY - rect.top);
  });
  scratchCanvas.addEventListener("pointerup", ()=>{
    scratching = false;
    const r = scratchedRatio();
    if(r >= 0.55) finishScratch();
  });
  scratchCanvas.addEventListener("pointercancel", ()=>{ scratching = false; });

  // 初始绘制刮层
  drawScratchCover();

})();
</script>
</body>
</html>
